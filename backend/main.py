from dotenv import load_dotenv
import os
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional
from openai import OpenAI


app = FastAPI()
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class FarmData(BaseModel):
    region: Optional[str] = ""
    temperature: Optional[str] = ""
    precipitation: Optional[str] = ""
    humidity: Optional[str] = ""
    soilType: Optional[str] = ""
    ph: Optional[str] = ""
    soilMoisture: Optional[str] = ""
    soilTemp: Optional[str] = ""
    crop: Optional[str] = ""
    plantingDate: Optional[str] = ""
    stage: Optional[str] = ""
    previousCrops: Optional[str] = ""
    area: Optional[str] = ""
    problems: Optional[str] = ""
    notes: Optional[str] = ""

@app.post("/api/analyze")
async def analyze(data: FarmData):
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        farm_info = f"""
üåç –†–ï–ì–ò–û–ù –ò –ö–õ–ò–ú–ê–¢:
–†–µ–≥–∏–æ–Ω: {data.region or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞: {data.temperature or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
–û—Å–∞–¥–∫–∏: {data.precipitation or '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
–í–ª–∞–∂–Ω–æ—Å—Ç—å –≤–æ–∑–¥—É—Ö–∞: {data.humidity or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}

üå± –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–ß–í–´:
–¢–∏–ø –ø–æ—á–≤—ã: {data.soilType or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–£—Ä–æ–≤–µ–Ω—å pH: {data.ph or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã: {data.soilMoisture or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ—á–≤—ã: {data.soilTemp or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}

üåæ –ö–£–õ–¨–¢–£–†–ê –ò –ü–õ–ê–ù–´:
–ö—É–ª—å—Ç—É—Ä–∞/—Å–æ—Ä—Ç: {data.crop or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
–î–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏: {data.plantingDate or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø: {data.stage or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–ß—Ç–æ —Ä–æ—Å–ª–æ –¥–æ —ç—Ç–æ–≥–æ: {data.previousCrops or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}

üìä –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
–†–∞–∑–º–µ—Ä —É—á–∞—Å—Ç–∫–∞: {data.area or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ—à–ª–æ–≥–æ —Å–µ–∑–æ–Ω–∞: {data.problems or '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}

üí¨ –ó–ê–ú–ï–¢–ö–ò –§–ï–†–ú–ï–†–ê:
{data.notes if data.notes else '–§–µ—Ä–º–µ—Ä –Ω–µ –æ—Å—Ç–∞–≤–∏–ª –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫'}
        """

        system_prompt = """–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –∞–≥—Ä–æ–Ω–æ–º-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –ø–æ–º–æ—â–∏ —Ñ–µ—Ä–º–µ—Ä–∞–º.

–ú–ò–°–°–ò–Ø: –ü–æ–º–æ–≥–∞–µ–º —Ñ–µ—Ä–º–µ—Ä–∞–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–º–∞—Ç–µ, –ø–æ—á–≤–µ –∏ –∫—É–ª—å—Ç—É—Ä–∞—Ö.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

–¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù —Å–æ–¥–µ—Ä–∂–∞—Ç—å –í–°–ï 4 —Ä–∞–∑–¥–µ–ª–∞ —Å –¢–û–ß–ù–´–ú–ò –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏:

### –ê–ù–ê–õ–ò–ó –°–ò–¢–£–ê–¶–ò–ò
[–û–ø–∏—à–∏ —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —É—á—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ—à–ª–æ–≥–æ —Å–µ–∑–æ–Ω–∞. 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.]

### –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–û–õ–ò–í–£
[–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –†–ê–ó–î–ï–õ!
- –ï—Å–ª–∏ —Ñ–µ—Ä–º–µ—Ä —Å–ø—Ä–∞—à–∏–≤–∞–ª –ø—Ä–æ —Å–∏—Å—Ç–µ–º—É –ø–æ–ª–∏–≤–∞ - –æ—Ç–≤–µ—Ç—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–∞—Å—á—ë—Ç–∞–º–∏
- –ß–∞—Å—Ç–æ—Ç–∞ –∏ –æ–±—ä—ë–º –ø–æ–ª–∏–≤–∞ —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–∞ –ø–æ—á–≤—ã
- –í—Ä–µ–º—è –ø–æ–ª–∏–≤–∞, –º–µ—Ç–æ–¥ (–∫–∞–ø–µ–ª—å–Ω—ã–π/–¥–æ–∂–¥–µ–≤–∞–Ω–∏–µ)
- –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏—è
–ú–∏–Ω–∏–º—É–º 3-4 –ø—É–Ω–∫—Ç–∞.]

### –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–ò–¢–ê–ù–ò–Æ –†–ê–°–¢–ï–ù–ò–ô
[–£–¥–æ–±—Ä–µ–Ω–∏—è, –¥–æ–∑–∏—Ä–æ–≤–∫–∏, —Å—Ä–æ–∫–∏ –≤–Ω–µ—Å–µ–Ω–∏—è. –û–±—ä—è—Å–Ω–∏ –∑–∞—á–µ–º. –ú–∏–Ω–∏–º—É–º 2-3 –ø—É–Ω–∫—Ç–∞.]

### –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–û–í–ï–¢–´
[–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –±–æ–ª–µ–∑–Ω–µ–π (–µ—Å–ª–∏ —Ñ–µ—Ä–º–µ—Ä —Å–ø—Ä–∞—à–∏–≤–∞–ª - –æ—Ç–≤–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ), –∞–≥—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥. –ú–∏–Ω–∏–º—É–º 2-3 –ø—É–Ω–∫—Ç–∞.]

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–û —ç—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å ### –≤ –Ω–∞—á–∞–ª–µ
- –ù–ï –ø—Ä–æ–ø—É—Å–∫–∞–π –Ω–∏ –æ–¥–∏–Ω —Ä–∞–∑–¥–µ–ª
- –ï—Å–ª–∏ —Ñ–µ—Ä–º–µ—Ä –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –≤ –∑–∞–º–µ—Ç–∫–∞—Ö - –æ—Ç–≤–µ—Ç—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ
- –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- –£—á–∏—Ç—ã–≤–∞–π —Ç–∏–ø –ø–æ—á–≤—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ—à–ª–æ–≥–æ —Å–µ–∑–æ–Ω–∞"""

        user_prompt = f"""–í–æ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç —Ñ–µ—Ä–º–µ—Ä–∞:

{farm_info}

–í–ê–ñ–ù–û: –§–µ—Ä–º–µ—Ä –∂–¥—ë—Ç –æ—Ç —Ç–µ–±—è –ø–æ–º–æ—â–∏. –ï—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å—ã –≤ –∑–∞–º–µ—Ç–∫–∞—Ö - –æ—Ç–≤–µ—Ç—å –Ω–∞ –Ω–∏—Ö –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏ –î–ï–¢–ê–õ–¨–ù–û –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö.

–¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –í–°–ï 4 —Ä–∞–∑–¥–µ–ª–∞:
1. –ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
2. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–ª–∏–≤—É (–¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–µ—Ä–º–µ—Ä –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª, –Ω–æ –û–°–û–ë–ï–ù–ù–û –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–ª!)
3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é —Ä–∞—Å—Ç–µ–Ω–∏–π
4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

–ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –Ω–∏ –æ–¥–∏–Ω —Ä–∞–∑–¥–µ–ª!"""

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.8,
            max_tokens=3000
        )
        
        result = response.choices[0].message.content
        return {"success": True, "analysis": result}
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))